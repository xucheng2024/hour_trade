# å°æ—¶å¼€ç›˜ä»·è·å–è¯´æ˜

## ğŸ“Š å¦‚ä½•è·å–

### æ–¹å¼1: ä»WebSocket Candleæ¶ˆæ¯è·å–ï¼ˆä¼˜å…ˆï¼Œæ›´å®æ—¶ï¼‰âœ…
**ç¨‹åºå·²ç»è®¢é˜…äº† `candle1H` WebSocketé€šé“**ï¼Œå½“æ–°å°æ—¶å¼€å§‹æ—¶ï¼ŒWebSocketä¼šè‡ªåŠ¨æ¨é€æ–°Kçº¿æ•°æ®ã€‚

**WebSocketæ•°æ®æ ¼å¼**ï¼š
```python
candle_data = [timestamp, open, high, low, close, volume, volCcy, volCcyQuote, confirm]
# candle_data[1] = å¼€ç›˜ä»·
```

**ä»£ç å®ç°**ï¼š
```python
def on_candle_message(ws, msg_string):
    # ... è§£æWebSocketæ¶ˆæ¯ ...
    if "candle1H" in channel:
        open_price = float(candle_data[1])  # ä»WebSocketè·å–å¼€ç›˜ä»·
        # æ›´æ–°å‚è€ƒä»·æ ¼
        reference_prices[instId] = open_price
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶ï¼šæ–°å°æ—¶å¼€å§‹æ—¶ç«‹å³æ”¶åˆ°æ•°æ®
- âœ… å‡†ç¡®ï¼šç›´æ¥æ¥è‡ªäº¤æ˜“æ‰€æ¨é€
- âœ… é¿å…æ—¶é—´å·®ï¼šä¸ä¼šå‡ºç°è·å–åˆ°ä¸Šä¸€å°æ—¶æ•°æ®çš„é—®é¢˜

---

### æ–¹å¼2: ä»REST APIè·å–ï¼ˆå¤‡ç”¨ï¼‰
```python
market_api.get_candlesticks(instId=instId, bar="1H", limit="1")
```

**å‚æ•°è¯´æ˜**ï¼š
- `bar="1H"`ï¼šè·å–1å°æ—¶Kçº¿æ•°æ®
- `limit="1"`ï¼šåªè·å–æœ€æ–°1æ¡Kçº¿

**âš ï¸ é‡è¦**ï¼š
- åœ¨æ•´ç‚¹æ—¶åˆ»ï¼ˆå¦‚11:00:00ï¼‰ç«‹å³è°ƒç”¨ï¼Œå¯èƒ½è·å–åˆ°ä¸Šä¸€å°æ—¶çš„æ•°æ®
- éœ€è¦éªŒè¯è¿”å›Kçº¿çš„æ—¶é—´æˆ³ï¼Œç¡®ä¿æ˜¯å½“å‰å°æ—¶çš„
- å»ºè®®å»¶è¿Ÿå‡ ç§’ï¼ˆå¦‚11:00:05ï¼‰å†è°ƒç”¨ï¼Œç¡®ä¿æ–°å°æ—¶Kçº¿å·²ç”Ÿæˆ

**ä»£ç å®ç°**ï¼š
```python
def fetch_current_hour_open_price(instId: str) -> Optional[float]:
    """ä»REST APIè·å–å½“å‰å°æ—¶çš„å¼€ç›˜ä»·ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰"""
    result = market_api.get_candlesticks(instId=instId, bar="1H", limit="1")
    if result.get("code") == "0" and result.get("data"):
        candle = result["data"][0]
        candle_ts = int(candle[0]) / 1000
        # éªŒè¯æ—¶é—´æˆ³ï¼Œç¡®ä¿æ˜¯å½“å‰å°æ—¶çš„Kçº¿
        current_hour_start = datetime.now().replace(minute=0, second=0, microsecond=0).timestamp()
        candle_hour_start = datetime.fromtimestamp(candle_ts).replace(minute=0, second=0, microsecond=0).timestamp()
        
        if abs(candle_hour_start - current_hour_start) <= 60:
            hour_open = float(candle[1])  # å–å¼€ç›˜ä»·
            return hour_open
    return None
```

---

## â° ä»€ä¹ˆæ—¶å€™è·å–

### æ—¶æœº1: ç¨‹åºå¯åŠ¨æ—¶ï¼ˆä¸€æ¬¡æ€§æ‰¹é‡è·å–ï¼‰
**ä½ç½®**ï¼š`main()` å‡½æ•°ä¸­ï¼Œåœ¨å¯åŠ¨WebSocketä¹‹å‰

**ä»£ç **ï¼š
```python
def main():
    # ... åŠ è½½é…ç½® ...
    
    # åˆå§‹åŒ–æ‰€æœ‰å¸ç§çš„å°æ—¶å¼€ç›˜ä»·
    initialize_reference_prices()  # ğŸ‘ˆ è¿™é‡Œ
    
    # ... å¯åŠ¨WebSocket ...
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. éå†æ‰€æœ‰é…ç½®çš„å¸ç§ï¼ˆä» `crypto_limits`ï¼‰
2. ä¸ºæ¯ä¸ªå¸ç§è°ƒç”¨ `fetch_current_hour_open_price()`
3. å°†ç»“æœå­˜å‚¨åœ¨ `reference_prices` å­—å…¸ä¸­
4. æ¯ä¸ªAPIè°ƒç”¨é—´éš”0.1ç§’ï¼ˆé¿å…è§¦å‘é™æµï¼‰

**ç¤ºä¾‹æ—¥å¿—**ï¼š
```
ğŸ”„ Initializing reference prices (current hour's open) for all cryptos...
ğŸ“Š BTC-USDT current hour's open price: $50000.000000
ğŸ“Š ETH-USDT current hour's open price: $3000.000000
...
âœ… Initialized 36/36 reference prices (current hour's open)
```

---

### æ—¶æœº2: æ¯ä¸ªæ–°å°æ—¶å¼€å§‹æ—¶ï¼ˆWebSocketè‡ªåŠ¨æ¨é€ï¼‰âœ… ä¼˜å…ˆæ–¹å¼
**ä½ç½®**ï¼š`on_candle_message()` å‡½æ•°ä¸­

**ä»£ç **ï¼š
```python
def on_candle_message(ws, msg_string):
    # WebSocketæ¥æ”¶åˆ°æ–°å°æ—¶çš„Kçº¿æ•°æ®
    if "candle1H" in channel:
        open_price = float(candle_data[1])  # å¼€ç›˜ä»·
        # è‡ªåŠ¨æ›´æ–°å‚è€ƒä»·æ ¼
        reference_prices[instId] = open_price  # ğŸ‘ˆ è¿™é‡Œ
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. WebSocketè®¢é˜…äº† `candle1H` é€šé“
2. æ–°å°æ—¶å¼€å§‹æ—¶ï¼ŒOKXè‡ªåŠ¨æ¨é€æ–°Kçº¿æ•°æ®
3. `on_candle_message()` æ¥æ”¶åˆ°æ•°æ®ï¼Œæå–å¼€ç›˜ä»·
4. è‡ªåŠ¨æ›´æ–° `reference_prices` å­—å…¸

**è§¦å‘æ—¶é—´**ï¼šæ–°å°æ—¶å¼€å§‹æ—¶ï¼ŒOKXè‡ªåŠ¨æ¨é€ï¼ˆé€šå¸¸æ˜¯æ•´ç‚¹åå‡ ç§’å†…ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶å‡†ç¡®ï¼šç›´æ¥æ¥è‡ªäº¤æ˜“æ‰€æ¨é€
- âœ… é¿å…æ—¶é—´å·®é—®é¢˜ï¼šä¸ä¼šè·å–åˆ°ä¸Šä¸€å°æ—¶çš„æ•°æ®
- âœ… è‡ªåŠ¨æ›´æ–°ï¼šæ— éœ€å®šæ—¶æ£€æŸ¥

**ç¤ºä¾‹æ—¥å¿—**ï¼š
```
[2026-01-15 10:00:03] ğŸ“Š BTC-USDT updated reference price from WebSocket: $50100.000000 (hour=10:00)
[2026-01-15 10:00:03] ğŸ“Š ETH-USDT updated reference price from WebSocket: $3010.000000 (hour=10:00)
```

---

### æ—¶æœº2b: æ¯ä¸ªæ–°å°æ—¶å¼€å§‹æ—¶ï¼ˆREST APIå¤‡ç”¨åˆ·æ–°ï¼‰
**ä½ç½®**ï¼š`main()` å‡½æ•°çš„å¥åº·æ£€æŸ¥å¾ªç¯ä¸­

**ä»£ç **ï¼š
```python
# ä¸»å¾ªç¯ï¼šæ¯60ç§’æ£€æŸ¥ä¸€æ¬¡
while True:
    time.sleep(60)  # æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡
    
    # æ£€æŸ¥æ˜¯å¦è¿›å…¥æ–°å°æ—¶ï¼ˆå»¶è¿Ÿ1åˆ†é’Ÿåï¼Œç¡®ä¿æ–°å°æ—¶Kçº¿å·²ç”Ÿæˆï¼‰
    now = datetime.now()
    current_hour = now.replace(minute=0, second=0, microsecond=0)
    if current_hour > last_refresh_hour and now.minute >= 1:
        # æ–°å°æ—¶åˆ°äº†ï¼Œä¸”å·²ç»è¿‡äº†1åˆ†é’Ÿï¼Œåˆ·æ–°æ‰€æœ‰å‚è€ƒä»·æ ¼ï¼ˆå¤‡ç”¨ï¼‰
        initialize_reference_prices()  # ğŸ‘ˆ è¿™é‡Œ
        last_refresh_hour = current_hour
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. ä¸»å¾ªç¯æ¯60ç§’è¿è¡Œä¸€æ¬¡
2. æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦è¿›å…¥äº†æ–°çš„å°æ—¶
3. **é‡è¦**ï¼šåªæœ‰å½“ `now.minute >= 1` æ—¶æ‰åˆ·æ–°ï¼ˆç¡®ä¿æ–°å°æ—¶Kçº¿å·²ç”Ÿæˆï¼‰
4. å¦‚æœè¿›å…¥æ–°å°æ—¶ï¼Œé‡æ–°è·å–æ‰€æœ‰å¸ç§çš„å°æ—¶å¼€ç›˜ä»·ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**è§¦å‘æ—¶é—´**ï¼šæ¯ä¸ªæ•´ç‚¹å1åˆ†é’Ÿï¼ˆ00:01, 01:01, 02:01, ..., 23:01ï¼‰

**ä½œç”¨**ï¼š
- ä½œä¸ºWebSocketçš„å¤‡ç”¨æ–¹æ¡ˆ
- å¦‚æœWebSocketæ•°æ®ä¸¢å¤±æˆ–å»¶è¿Ÿï¼ŒREST APIå¯ä»¥è¡¥å……

**ç¤ºä¾‹æ—¥å¿—**ï¼š
```
[2026-01-15 10:01:00] ğŸ”„ New hour detected (10:00), refreshing reference prices (hourly open)...
[2026-01-15 10:01:01] ğŸ“Š BTC-USDT current hour's open price: $50100.000000 (ts=10:00:00)
[2026-01-15 10:01:05] âœ… Initialized 36/36 reference prices (current hour's open)
```

---

### æ—¶æœº3: å®æ—¶æ£€æŸ¥æ—¶ï¼ˆæŒ‰éœ€è·å–ï¼‰
**ä½ç½®**ï¼š`on_ticker_message()` å‡½æ•°ä¸­ï¼Œæ£€æŸ¥ä¹°å…¥ä¿¡å·æ—¶

**ä»£ç **ï¼š
```python
def on_ticker_message(ws, msg_string):
    # ... è§£ætickeræ•°æ® ...
    
    for ticker in data:
        instId = ticker.get("instId")
        last_price = float(ticker.get("last", 0))
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¹°å…¥
        if instId not in pending_buys and instId not in active_orders:
            # è·å–å‚è€ƒä»·æ ¼
            with lock:
                ref_price = reference_prices.get(instId)
            
            # å¦‚æœæ²¡æœ‰å‚è€ƒä»·æ ¼ï¼Œå®æ—¶è·å–
            if ref_price is None or ref_price <= 0:
                ref_price = fetch_current_hour_open_price(instId)  # ğŸ‘ˆ è¿™é‡Œ
                if ref_price and ref_price > 0:
                    with lock:
                        reference_prices[instId] = ref_price
                else:
                    continue  # è·å–å¤±è´¥ï¼Œè·³è¿‡æœ¬æ¬¡æ£€æŸ¥
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. æ”¶åˆ°tickerä»·æ ¼æ›´æ–°
2. æ£€æŸ¥è¯¥å¸ç§æ˜¯å¦æœ‰å‚è€ƒä»·æ ¼
3. å¦‚æœæ²¡æœ‰ï¼ˆä¾‹å¦‚ï¼šæ–°æ·»åŠ çš„å¸ç§ã€æˆ–ä¹‹å‰çš„è·å–å¤±è´¥ï¼‰ï¼Œç«‹å³è·å–
4. å¦‚æœè·å–æˆåŠŸï¼Œå­˜å‚¨åˆ° `reference_prices` å¹¶ç»§ç»­æ£€æŸ¥ä¹°å…¥ä¿¡å·
5. å¦‚æœè·å–å¤±è´¥ï¼Œè·³è¿‡æœ¬æ¬¡æ£€æŸ¥ï¼Œç­‰å¾…ä¸‹æ¬¡tickeræ›´æ–°

**è§¦å‘æ¡ä»¶**ï¼š
- æŸä¸ªå¸ç§æ²¡æœ‰å‚è€ƒä»·æ ¼ï¼ˆ`reference_prices[instId]` ä¸ºç©ºæˆ–0ï¼‰
- æ¯æ¬¡tickeræ¶ˆæ¯åˆ°è¾¾æ—¶éƒ½ä¼šæ£€æŸ¥

**ç¤ºä¾‹æ—¥å¿—**ï¼š
```
âš ï¸ No reference price for NEW-COIN-USDT, fetching current hour's open...
ğŸ“Š NEW-COIN-USDT current hour's open price: $1.500000
```

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
ç¨‹åºå¯åŠ¨
    â†“
åˆå§‹åŒ–å‚è€ƒä»·æ ¼ï¼ˆæ‰¹é‡è·å–æ‰€æœ‰å¸ç§ï¼‰
    â†“
å¯åŠ¨WebSocketè¿æ¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»å¾ªç¯ï¼ˆæ¯60ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰            â”‚
â”‚                                     â”‚
â”‚  1. æ£€æŸ¥æ˜¯å¦è¿›å…¥æ–°å°æ—¶ï¼Ÿ            â”‚
â”‚     - æ˜¯ â†’ åˆ·æ–°æ‰€æœ‰å‚è€ƒä»·æ ¼          â”‚
â”‚     - å¦ â†’ ç»§ç»­                    â”‚
â”‚                                     â”‚
â”‚  2. WebSocketæ”¶åˆ°tickeræ¶ˆæ¯         â”‚
â”‚     - æ£€æŸ¥æ˜¯å¦æœ‰å‚è€ƒä»·æ ¼ï¼Ÿ           â”‚
â”‚     - æ²¡æœ‰ â†’ å®æ—¶è·å–                â”‚
â”‚     - æœ‰ â†’ ä½¿ç”¨ç¼“å­˜çš„å‚è€ƒä»·æ ¼        â”‚
â”‚                                     â”‚
â”‚  3. æ£€æŸ¥ä¹°å…¥ä¿¡å·...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ é‡è¦è¯´æ˜

### 1. å½“å‰å°æ—¶çš„å«ä¹‰
- OKXçš„1å°æ—¶Kçº¿æŒ‰æ•´ç‚¹åˆ’åˆ†ï¼ˆ00:00, 01:00, 02:00, ...ï¼‰
- WebSocketæ¨é€æ–°Kçº¿æ—¶ï¼Œä¼šåŒ…å«è¯¥å°æ—¶çš„å¼€ç›˜ä»·ï¼ˆæ•´ç‚¹æ—¶åˆ»çš„ä»·æ ¼ï¼‰
- ä¾‹å¦‚ï¼š10:00å¼€å§‹æ—¶ï¼ŒWebSocketæ¨é€10:00-11:00å°æ—¶çš„å¼€ç›˜ä»·ï¼ˆ10:00:00çš„ä»·æ ¼ï¼‰

### 2. ä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨WebSocketï¼Ÿ
- âœ… **é¿å…æ—¶é—´å·®é—®é¢˜**ï¼šåœ¨æ•´ç‚¹æ—¶åˆ»ï¼ŒREST APIå¯èƒ½è¿”å›ä¸Šä¸€å°æ—¶çš„æ•°æ®
- âœ… **å®æ—¶å‡†ç¡®**ï¼šWebSocketç”±äº¤æ˜“æ‰€ä¸»åŠ¨æ¨é€ï¼Œç¡®ä¿æ˜¯æœ€æ–°æ•°æ®
- âœ… **è‡ªåŠ¨æ›´æ–°**ï¼šæ— éœ€å®šæ—¶è½®è¯¢ï¼Œå‡å°‘APIè°ƒç”¨

### 3. REST APIçš„æ—¶é—´å·®é—®é¢˜
- âŒ **é—®é¢˜**ï¼šåœ¨11:00:00ç«‹å³è°ƒç”¨APIï¼Œå¯èƒ½è·å–åˆ°10:00-11:00çš„Kçº¿ï¼ˆä¸Šä¸€å°æ—¶ï¼‰
- âœ… **è§£å†³**ï¼š
  1. å»¶è¿Ÿè·å–ï¼šç­‰åˆ°11:00:05å†è·å–ï¼ˆ`now.minute >= 1`ï¼‰
  2. éªŒè¯æ—¶é—´æˆ³ï¼šæ£€æŸ¥è¿”å›Kçº¿çš„æ—¶é—´æˆ³ï¼Œç¡®ä¿æ˜¯å½“å‰å°æ—¶çš„
  3. ä½¿ç”¨WebSocketï¼šä¼˜å…ˆä½¿ç”¨WebSocketæ•°æ®ï¼ŒREST APIä½œä¸ºå¤‡ç”¨

### 4. ä¸ºä»€ä¹ˆæ¯å°æ—¶åˆ·æ–°ï¼Ÿ
- æ¯ä¸ªæ–°å°æ—¶ï¼Œå‚è€ƒä»·æ ¼ä¼šå˜åŒ–
- ä¾‹å¦‚ï¼š10:00çš„å°æ—¶å¼€ç›˜ä»·æ˜¯$100ï¼Œ11:00çš„å°æ—¶å¼€ç›˜ä»·å¯èƒ½æ˜¯$105
- æ‰€ä»¥åœ¨11:00æ—¶ï¼Œåº”è¯¥ä½¿ç”¨$105ä½œä¸ºæ–°çš„å‚è€ƒä»·æ ¼

### 5. å®æ—¶è·å–çš„ä½œç”¨
- ä¸»è¦ä½œä¸º**å…œåº•æœºåˆ¶**ï¼Œé˜²æ­¢æŸäº›å¸ç§æ²¡æœ‰å‚è€ƒä»·æ ¼
- æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‚è€ƒä»·æ ¼åº”è¯¥é€šè¿‡WebSocketè‡ªåŠ¨æ›´æ–°
- åªæœ‰åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼ˆå¦‚WebSocketæ•°æ®ä¸¢å¤±ã€æ–°æ·»åŠ å¸ç§ï¼‰æ‰ä¼šè§¦å‘REST APIè·å–

---

## ğŸ“ ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1: ç¨‹åºåœ¨10:30å¯åŠ¨
```
10:30:00 - ç¨‹åºå¯åŠ¨
10:30:01 - åˆå§‹åŒ–å‚è€ƒä»·æ ¼ï¼Œè·å–æ‰€æœ‰å¸ç§çš„10:00-11:00å°æ—¶å¼€ç›˜ä»·ï¼ˆREST APIï¼‰
10:30:05 - å¼€å§‹ç›‘æ§tickerï¼Œä½¿ç”¨åˆšæ‰è·å–çš„å‚è€ƒä»·æ ¼
11:00:03 - WebSocketæ¨é€11:00-12:00å°æ—¶çš„æ–°Kçº¿ï¼Œè‡ªåŠ¨æ›´æ–°å‚è€ƒä»·æ ¼ âœ…
11:01:00 - REST APIå¤‡ç”¨åˆ·æ–°ï¼ˆå¦‚æœWebSocketæ•°æ®ä¸¢å¤±ï¼‰ğŸ”„
12:00:03 - WebSocketæ¨é€12:00-13:00å°æ—¶çš„æ–°Kçº¿ï¼Œè‡ªåŠ¨æ›´æ–°å‚è€ƒä»·æ ¼ âœ…
...
```

### åœºæ™¯2: æŸä¸ªå¸ç§è·å–å¤±è´¥
```
10:30:01 - åˆå§‹åŒ–æ—¶ï¼ŒBTC-USDTè·å–æˆåŠŸï¼ŒETH-USDTè·å–å¤±è´¥
10:30:02 - ETH-USDTçš„reference_pricesä¸ºç©º
10:30:10 - æ”¶åˆ°ETH-USDTçš„tickeræ¶ˆæ¯
10:30:11 - æ£€æµ‹åˆ°ETH-USDTæ²¡æœ‰å‚è€ƒä»·æ ¼ï¼Œå®æ—¶è·å–
10:30:12 - è·å–æˆåŠŸï¼Œå­˜å‚¨åˆ°reference_prices
10:30:13 - ç»§ç»­æ£€æŸ¥ä¹°å…¥ä¿¡å·
```

### åœºæ™¯3: æ–°å°æ—¶å¼€å§‹æ—¶
```
10:59:58 - ä½¿ç”¨10:00-11:00å°æ—¶çš„å¼€ç›˜ä»·ä½œä¸ºå‚è€ƒ
11:00:00 - ä¸»å¾ªç¯æ£€æµ‹åˆ°æ–°å°æ—¶
11:00:01 - åˆ·æ–°æ‰€æœ‰å‚è€ƒä»·æ ¼ï¼Œè·å–11:00-12:00å°æ—¶çš„å¼€ç›˜ä»·
11:00:05 - ä¹‹åçš„æ‰€æœ‰ä¹°å…¥ä¿¡å·æ£€æŸ¥éƒ½ä½¿ç”¨æ–°çš„å‚è€ƒä»·æ ¼
```
