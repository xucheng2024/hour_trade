# 卖出机制说明

## 核心答案

**websocket_limit_trading.py 是唯一的卖出执行者**

所有卖出操作都由 `websocket_limit_trading.py` 处理，具有双重保障机制确保可靠执行。

## 详细说明

### websocket_limit_trading.py（卖出机制）

#### 触发方式

**方式一：WebSocket K 线确认事件（主要方式）**
- 当收到 WebSocket K 线消息，且 `confirm == "1"`（K 线已确认/关闭）
- 检查 `next_hour_close_time` 是否到达
- 如果到达，触发 `process_sell_signal()` 或 `process_momentum_sell_signal()`
- 执行市价卖出

**方式二：超时检查（后备机制）**
- `check_sell_timeout()` 后台线程每 30 秒检查一次
- 如果 `next_hour_close_time` 已过，但 `sell_triggered` 仍为 `False`
- 自动触发卖出（防止 WebSocket 事件丢失）
- **这确保了即使 WebSocket 事件丢失，也能在 30 秒内发现并卖出**

#### 卖出时机

- **策略逻辑**：买入后，在**下一个小时开始时**卖出
- **具体时间**：`next_hour_close_time`（下一个小时的整点时间）

#### 卖出流程

```python
1. 收到 K 线确认事件 (confirm == "1")
   ↓
2. 检查 next_hour_close_time 是否到达
   ↓
3. 设置 sell_triggered = True（防止重复触发）
   ↓
4. 启动线程执行 process_sell_signal()
   ↓
5. 检查订单状态（必须是 "filled"）
   ↓
6. 调用 sell_market_order() 执行市价卖出
   ↓
7. 更新数据库：state = "sold out"
   ↓
8. 从 active_orders 中移除
```

#### 容错机制

**双重保障**：
1. **主要机制**：WebSocket K 线确认事件（实时响应）
2. **后备机制**：`check_sell_timeout()` 每 30 秒检查（确保不遗漏）

**数据库同步**：
- `sync_orders_from_database()` 每 5 分钟同步一次
- 确保内存状态与数据库状态一致
- 处理外部操作或手动修改的情况

## 流程图

```
正常情况（主要流程）：
┌─────────────────────────────────────┐
│ websocket_limit_trading.py          │
│                                      │
│ 1. 买入订单                          │
│ 2. 等待下一个小时                    │
│ 3. 收到 K 线确认事件 (confirm="1")   │
│ 4. 触发卖出                          │
│ 5. 执行市价卖出                      │
│ 6. 更新数据库                        │
└─────────────────────────────────────┘
         ✅ 卖出完成（实时响应）

异常情况（后备机制）：
┌─────────────────────────────────────┐
│ websocket_limit_trading.py          │
│                                      │
│ 1. 买入订单                          │
│ 2. 等待下一个小时                    │
│ 3. ❌ WebSocket 事件丢失              │
│ 4. check_sell_timeout() 检测到超时  │
│ 5. 自动触发卖出（30秒内）            │
│ 6. 执行市价卖出                      │
│ 7. 更新数据库                        │
└─────────────────────────────────────┘
         ✅ 卖出完成（后备保障）
```

## 关键特性

| 特性 | 说明 |
|------|------|
| **主要职责** | 在下一个小时开始时卖出 |
| **触发时机** | 下一个小时开始时 |
| **数据来源** | `orders` 表（内存 + 数据库） |
| **运行方式** | 持续运行（WebSocket 连接） |
| **容错机制** | 双重保障（K线事件 + 超时检查） |
| **同步机制** | 每 5 分钟同步数据库状态 |

## 总结

- **websocket_limit_trading.py**：唯一的卖出执行者
- **双重保障**：K 线确认事件 + 超时检查（30秒间隔）
- **数据库同步**：每 5 分钟同步，确保状态一致

这确保了：
1. 正常情况下及时卖出（下一个小时，实时响应）
2. 异常情况下也能可靠卖出（30秒内检测并处理）
3. 不会出现长期持仓的情况
