<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Records</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            color-scheme: light;
            --bg: #f6f7fb;
            --card: #ffffff;
            --text: #101828;
            --muted: #667085;
            --border: #e4e7ec;
            --accent: #111827;
            --pos: #16a34a;
            --neg: #dc2626;
            --chip: #f2f4f7;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 14px;
            font-size: 13px;
            line-height: 1.4;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        h1 { font-size: 18px; font-weight: 700; letter-spacing: 0.2px; }
        .refresh-info { font-size: 11px; color: var(--muted); background: var(--chip); padding: 4px 8px; border-radius: 6px; }
        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        .summary-item { background: var(--card); padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); }
        .summary-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 4px; font-weight: 600; }
        .summary-value { font-size: 18px; font-weight: 700; }
        .profit-positive { color: var(--pos); }
        .profit-negative { color: var(--neg); }
        .crypto-section { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
        .crypto-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: #f9fafb; border-bottom: 1px solid var(--border); }
        .crypto-name { font-size: 14px; font-weight: 700; color: var(--accent); }
        .crypto-profit { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: #f2f4f7; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th {
            background: #fafafa;
            color: var(--muted);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th.num { text-align: right; }
        td { padding: 8px 10px; border-bottom: 1px solid #f2f4f7; vertical-align: middle; }
        td.num { text-align: right; font-family: 'SF Mono', 'Monaco', 'Courier New', monospace; font-weight: 500; }
        td.text { text-align: left; }
        tr:hover { background: #f9fafb; }
        tr.profit-row { background: #ecfdf3; }
        tr.profit-row:hover { background: #d1fadf; }
        tr.loss-row { background: #fef2f2; }
        tr.loss-row:hover { background: #fee2e2; }
        .status-badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .status-active { background: #fef3c7; color: #92400e; }
        .status-sold { background: #d1fae5; color: #065f46; }
        .loading { text-align: center; padding: 48px; color: var(--muted); font-size: 13px; }
        @media (max-width: 900px) {
            .summary { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            body { padding: 10px; }
            .summary { grid-template-columns: 1fr; }
            .crypto-header { flex-direction: column; gap: 8px; align-items: flex-start; }
            table { font-size: 11px; }
            th, td { padding: 6px 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Trading Records</h1>
            <div class="refresh-info" id="refresh-info">Loading...</div>
        </div>
        <div class="summary">
            <div class="summary-item">
                <div class="summary-label">Cryptos</div>
                <div class="summary-value" id="total-cryptos">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Trades</div>
                <div class="summary-value" id="total-trades">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Total Profit</div>
                <div class="summary-value" id="total-profit">-</div>
            </div>
        </div>
        <div class="summary" style="margin-top: 12px;">
            <div class="summary-item">
                <div class="summary-label">Original Strategy</div>
                <div class="summary-value" id="original-profit">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Original Gap</div>
                <div class="summary-value" id="original-gap-profit">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Stable Strategy</div>
                <div class="summary-value" id="stable-profit">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Batch Strategy</div>
                <div class="summary-value" id="batch-profit">-</div>
            </div>
        </div>
        <div id="crypto-list" class="loading">Loading data...</div>
    </div>

    <script>
        let refreshTimer;

        async function loadData() {
            try {
                const response = await fetch('/api/orders');
                const result = await response.json();
                
                if (result.success) {
                    updateUI(result.data);
                    document.getElementById('refresh-info').textContent = 'Auto-refresh: 30s';
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('crypto-list').innerHTML = 
                    '<div class="loading">Failed to load data. Retrying...</div>';
            }
            
            // Auto refresh every 30 seconds
            clearTimeout(refreshTimer);
            refreshTimer = setTimeout(loadData, 30000);
        }

        function updateUI(data) {
            // Update summary
            document.getElementById('total-cryptos').textContent = data.total_cryptos;
            document.getElementById('total-trades').textContent = data.total_trades;
            
            const profitEl = document.getElementById('total-profit');
            profitEl.textContent = data.total_profit.toFixed(2) + ' USDT';
            profitEl.className = 'summary-value ' + 
                (data.total_profit > 0 ? 'profit-positive' : 
                 data.total_profit < 0 ? 'profit-negative' : '');
            
            // Update strategy-specific profits
            if (data.strategies) {
                const originalProfit = data.strategies['hourly_limit_ws']?.profit || 0;
                const stableProfit = data.strategies['stable_buy_ws']?.profit || 0;
                const batchProfit = data.strategies['batch_buy_ws']?.profit || 0;
                const gapProfit = data.strategies['original_gap']?.profit || 0;
                
                const originalEl = document.getElementById('original-profit');
                originalEl.textContent = originalProfit.toFixed(2) + ' USDT';
                originalEl.className = 'summary-value ' + 
                    (originalProfit > 0 ? 'profit-positive' : 
                     originalProfit < 0 ? 'profit-negative' : '');
                
                const stableEl = document.getElementById('stable-profit');
                stableEl.textContent = stableProfit.toFixed(2) + ' USDT';
                stableEl.className = 'summary-value ' + 
                    (stableProfit > 0 ? 'profit-positive' : 
                     stableProfit < 0 ? 'profit-negative' : '');
                
                const batchEl = document.getElementById('batch-profit');
                batchEl.textContent = batchProfit.toFixed(2) + ' USDT';
                batchEl.className = 'summary-value ' + 
                    (batchProfit > 0 ? 'profit-positive' : 
                     batchProfit < 0 ? 'profit-negative' : '');

                const gapEl = document.getElementById('original-gap-profit');
                gapEl.textContent = gapProfit.toFixed(2) + ' USDT';
                gapEl.className = 'summary-value ' + 
                    (gapProfit > 0 ? 'profit-positive' : 
                     gapProfit < 0 ? 'profit-negative' : '');
            }
            
            // Render crypto list
            const cryptoList = document.getElementById('crypto-list');
            
            if (Object.keys(data.cryptos).length === 0) {
                cryptoList.innerHTML = '<div class="loading">No trading records found</div>';
                return;
            }
            
            let html = '';
            for (const [crypto, cryptoData] of Object.entries(data.cryptos)) {
                const profitClass = cryptoData.profit > 0 ? 'profit-positive' : 
                                   cryptoData.profit < 0 ? 'profit-negative' : '';
                
                // Get strategy-specific profits
                const originalProfit = cryptoData.strategies?.['hourly_limit_ws']?.profit || 0;
                const stableProfit = cryptoData.strategies?.['stable_buy_ws']?.profit || 0;
                const batchProfit = cryptoData.strategies?.['batch_buy_ws']?.profit || 0;
                const originalTrades = cryptoData.strategies?.['hourly_limit_ws']?.trades?.length || 0;
                const stableTrades = cryptoData.strategies?.['stable_buy_ws']?.trades?.length || 0;
                const batchTrades = cryptoData.strategies?.['batch_buy_ws']?.trades?.length || 0;
                const gapProfit = cryptoData.strategies?.['original_gap']?.profit || 0;
                const gapTrades = cryptoData.strategies?.['original_gap']?.trades?.length || 0;
                
                html += `
                    <div class="crypto-section">
                        <div class="crypto-header">
                            <div class="crypto-name">${crypto}</div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div class="crypto-profit ${profitClass}">
                                    Total: ${cryptoData.profit.toFixed(2)} USDT (${cryptoData.profit_pct.toFixed(2)}%)
                                </div>
                                <div style="font-size: 12px; color: #718096;">
                                    Original: ${originalProfit.toFixed(2)} (${originalTrades}) | 
                                    Original Gap: ${gapProfit.toFixed(2)} (${gapTrades}) | 
                                    Stable: ${stableProfit.toFixed(2)} (${stableTrades}) | 
                                    Batch: ${batchProfit.toFixed(2)} (${batchTrades})
                                </div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="text">Buy Time</th>
                                    <th class="text">Sell Time</th>
                                    <th class="text">Strategy</th>
                                    <th class="num">Buy Price</th>
                                    <th class="num">Sell Price</th>
                                    <th class="num">Size</th>
                                    <th class="num">Amount</th>
                                    <th class="num">Profit %</th>
                                    <th class="text">Status</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                // Format price function - show more decimals for small prices
                function formatPrice(price) {
                    if (!price || price === 0) return '0.00';
                    if (price < 1e-8) return price.toExponential(2);
                    let fixed;
                    if (price >= 1) fixed = price.toFixed(2);
                    else if (price >= 0.01) fixed = price.toFixed(4);
                    else if (price >= 0.001) fixed = price.toFixed(5);
                    else if (price >= 0.0001) fixed = price.toFixed(6);
                    else if (price >= 0.00001) fixed = price.toFixed(7);
                    else fixed = price.toFixed(8);
                    // Trim trailing zeros to avoid long decimals
                    return fixed.replace(/\.?0+$/, '');
                }
                
                for (const trade of cryptoData.trades) {
                    const buyTimeStr = trade.buy_time || '-';
                    const sellTimeStr = trade.sell_time && trade.state === 'sold out' 
                        ? trade.sell_time 
                        : '-';
                    const buyPrice = formatPrice(trade.price);
                    const sellPrice = trade.sell_price > 0 ? formatPrice(trade.sell_price) : '-';
                    const statusClass = trade.state === 'sold out' ? 'status-sold' : 'status-active';
                    let strategyName = 'Original';
                    let strategyBgColor = '#fef3c7';
                    let strategyTextColor = '#92400e';
                    if (trade.strategy === 'stable_buy_ws') {
                        strategyName = 'Stable';
                        strategyBgColor = '#dbeafe';
                        strategyTextColor = '#1e40af';
                    } else if (trade.strategy === 'batch_buy_ws') {
                        strategyName = 'Batch';
                        strategyBgColor = '#e9d5ff';
                        strategyTextColor = '#6b21a8';
                    } else if (trade.strategy === 'original_gap') {
                        strategyName = 'Original Gap';
                        strategyBgColor = '#fee2e2';
                        strategyTextColor = '#991b1b';
                    }
                    
                    // Calculate profit percentage
                    let profitPct = '-';
                    let rowClass = '';
                    if (trade.profit_pct !== undefined && trade.sell_price > 0 && trade.price > 0) {
                        profitPct = trade.profit_pct.toFixed(2) + '%';
                        // Add row class based on profit/loss
                        if (trade.profit_pct > 0) {
                            rowClass = 'profit-row';
                        } else if (trade.profit_pct < 0) {
                            rowClass = 'loss-row';
                        }
                    }
                    
                    html += `
                        <tr class="${rowClass}">
                            <td class="text">${buyTimeStr}</td>
                            <td class="text">${sellTimeStr}</td>
                            <td class="text"><span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${strategyBgColor}; color: ${strategyTextColor};">${strategyName}</span></td>
                            <td class="num">${buyPrice}</td>
                            <td class="num">${sellPrice}</td>
                            <td class="num">${trade.size.toFixed(6)}</td>
                            <td class="num">${trade.amount.toFixed(2)}</td>
                            <td class="num ${trade.profit_pct > 0 ? 'profit-positive' : trade.profit_pct < 0 ? 'profit-negative' : ''}">${profitPct}</td>
                            <td class="text"><span class="status-badge ${statusClass}">${trade.state}</span></td>
                        </tr>`;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            }
            
            cryptoList.innerHTML = html;
        }

        // Load data on page load
        loadData();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => clearTimeout(refreshTimer));
    </script>
</body>
</html>
