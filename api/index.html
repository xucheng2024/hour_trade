<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Records</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa; color: #2d3748; padding: 16px; font-size: 14px;
            line-height: 1.5;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 24px; font-weight: 700; color: #1a202c; }
        .refresh-info { font-size: 12px; color: #718096; background: #edf2f7; padding: 4px 10px; border-radius: 6px; }
        .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
        .summary-item { background: #fff; padding: 16px 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .summary-label { font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
        .summary-value { font-size: 24px; font-weight: 700; }
        .profit-positive { color: #16a34a; }
        .profit-negative { color: #dc2626; }
        .crypto-section { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .crypto-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-bottom: 1px solid #e2e8f0; }
        .crypto-name { font-size: 16px; font-weight: 700; color: #1a202c; }
        .crypto-profit { font-size: 14px; font-weight: 600; padding: 6px 14px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f7fafc; color: #4a5568; font-weight: 600; font-size: 11px; 
             text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 16px; 
             text-align: left; border-bottom: 2px solid #e2e8f0; }
        th.num { text-align: right; }
        td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        td.num { text-align: right; font-family: 'SF Mono', 'Monaco', 'Courier New', monospace; font-weight: 500; }
        td.text { text-align: left; }
        tr:hover { background: #f7fafc; }
        tr.profit-row { background: #dcfce7; }
        tr.profit-row:hover { background: #bbf7d0; }
        tr.loss-row { background: #fee2e2; }
        tr.loss-row:hover { background: #fecaca; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .status-active { background: #fef3c7; color: #92400e; }
        .status-sold { background: #d1fae5; color: #065f46; }
        .loading { text-align: center; padding: 60px; color: #718096; font-size: 14px; }
        @media (max-width: 768px) {
            body { padding: 12px; }
            .summary { grid-template-columns: 1fr; gap: 12px; }
            .crypto-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            table { font-size: 12px; }
            th, td { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Trading Records</h1>
            <div class="refresh-info" id="refresh-info">Loading...</div>
        </div>
        <div class="summary">
            <div class="summary-item">
                <div class="summary-label">Cryptos</div>
                <div class="summary-value" id="total-cryptos">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Trades</div>
                <div class="summary-value" id="total-trades">-</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Profit</div>
                <div class="summary-value" id="total-profit">-</div>
            </div>
        </div>
        <div id="crypto-list" class="loading">Loading data...</div>
    </div>

    <script>
        let refreshTimer;

        async function loadData() {
            try {
                const response = await fetch('/api/orders');
                const result = await response.json();
                
                if (result.success) {
                    updateUI(result.data);
                    document.getElementById('refresh-info').textContent = 'Auto-refresh: 30s';
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('crypto-list').innerHTML = 
                    '<div class="loading">Failed to load data. Retrying...</div>';
            }
            
            // Auto refresh every 30 seconds
            clearTimeout(refreshTimer);
            refreshTimer = setTimeout(loadData, 30000);
        }

        function updateUI(data) {
            // Update summary
            document.getElementById('total-cryptos').textContent = data.total_cryptos;
            document.getElementById('total-trades').textContent = data.total_trades;
            
            const profitEl = document.getElementById('total-profit');
            profitEl.textContent = data.total_profit.toFixed(2) + ' USDT';
            profitEl.className = 'summary-value ' + 
                (data.total_profit > 0 ? 'profit-positive' : 
                 data.total_profit < 0 ? 'profit-negative' : '');
            
            // Render crypto list
            const cryptoList = document.getElementById('crypto-list');
            
            if (Object.keys(data.cryptos).length === 0) {
                cryptoList.innerHTML = '<div class="loading">No trading records found</div>';
                return;
            }
            
            let html = '';
            for (const [crypto, cryptoData] of Object.entries(data.cryptos)) {
                const profitClass = cryptoData.profit > 0 ? 'profit-positive' : 
                                   cryptoData.profit < 0 ? 'profit-negative' : '';
                
                html += `
                    <div class="crypto-section">
                        <div class="crypto-header">
                            <div class="crypto-name">${crypto}</div>
                            <div class="crypto-profit ${profitClass}">
                                ${cryptoData.profit.toFixed(2)} USDT (${cryptoData.profit_pct.toFixed(2)}% - ${cryptoData.trades.length}ç¬”)
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="text">Time</th>
                                    <th class="num">Buy Price</th>
                                    <th class="num">Sell Price</th>
                                    <th class="num">Size</th>
                                    <th class="num">Amount</th>
                                    <th class="num">Profit %</th>
                                    <th class="text">Status</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                // Format price function - show more decimals for small prices
                function formatPrice(price) {
                    if (!price || price === 0) return '0.00';
                    if (price >= 1) return price.toFixed(2);
                    if (price >= 0.01) return price.toFixed(4);
                    if (price >= 0.001) return price.toFixed(5);
                    if (price >= 0.0001) return price.toFixed(6);
                    if (price >= 0.00001) return price.toFixed(7);
                    return price.toFixed(8);
                }
                
                for (const trade of cryptoData.trades) {
                    const timeStr = trade.state === 'sold out' && trade.sell_time ? 
                                   trade.sell_time : trade.buy_time;
                    const buyPrice = formatPrice(trade.price);
                    const sellPrice = trade.sell_price > 0 ? formatPrice(trade.sell_price) : '-';
                    const statusClass = trade.state === 'sold out' ? 'status-sold' : 'status-active';
                    
                    // Calculate profit percentage
                    let profitPct = '-';
                    let rowClass = '';
                    if (trade.profit_pct !== undefined && trade.sell_price > 0 && trade.price > 0) {
                        profitPct = trade.profit_pct.toFixed(2) + '%';
                        // Add row class based on profit/loss
                        if (trade.profit_pct > 0) {
                            rowClass = 'profit-row';
                        } else if (trade.profit_pct < 0) {
                            rowClass = 'loss-row';
                        }
                    }
                    
                    html += `
                        <tr class="${rowClass}">
                            <td class="text">${timeStr}</td>
                            <td class="num">${buyPrice}</td>
                            <td class="num">${sellPrice}</td>
                            <td class="num">${trade.size.toFixed(6)}</td>
                            <td class="num">${trade.amount.toFixed(2)}</td>
                            <td class="num ${trade.profit_pct > 0 ? 'profit-positive' : trade.profit_pct < 0 ? 'profit-negative' : ''}">${profitPct}</td>
                            <td class="text"><span class="status-badge ${statusClass}">${trade.state}</span></td>
                        </tr>`;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            }
            
            cryptoList.innerHTML = html;
        }

        // Load data on page load
        loadData();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => clearTimeout(refreshTimer));
    </script>
</body>
</html>
